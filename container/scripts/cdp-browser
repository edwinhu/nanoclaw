#!/bin/bash
# CDP Browser Helper - Connect to host machine's Chrome/Electron apps via CDP
# Supports: superhuman, morgen, chrome
# Usage: cdp-browser <app> <command> [args]

HOST_IP="host.docker.internal"  # Docker networking to reach host

# App configurations — all served by headless Chrome on host (port 9400)
CDP_DEFAULT="${CDP_PORT:-9400}"
declare -A CDP_PORTS=(
  [superhuman]=$CDP_DEFAULT
  [morgen]=$CDP_DEFAULT
  [chrome]=$CDP_DEFAULT
)

APP="${1:-superhuman}"
COMMAND="${2:-check}"

if [[ -z "${CDP_PORTS[$APP]}" ]]; then
  echo "ERROR: Unknown app '${APP}'"
  echo "Supported apps: ${!CDP_PORTS[@]}"
  exit 1
fi

CDP_PORT="${CDP_PORTS[$APP]}"
CDP_URL="http://${HOST_IP}:${CDP_PORT}"

# Test if CDP endpoint is reachable
check_connection() {
  # Use Host: localhost header to bypass Chrome's host validation
  if ! curl -s --connect-timeout 2 -H "Host: localhost" "${CDP_URL}/json/version" > /dev/null 2>&1; then
    echo "ERROR: Cannot reach ${APP} CDP endpoint at ${CDP_URL}"
    echo ""
    echo "Make sure headless Chrome is running on port ${CDP_PORT}"
    echo ""
    echo "On host machine, run:"
    echo "  nanoclaw-chrome start"
    return 1
  fi
  return 0
}

# Get browser WebSocket endpoint
get_ws_endpoint() {
  curl -s -H "Host: localhost" "${CDP_URL}/json/version" | node -e "
    const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
    // Replace localhost with host.docker.internal for container access
    const ws = data.webSocketDebuggerUrl.replace('ws://localhost/', 'ws://${HOST_IP}:${CDP_PORT}/');
    console.log(ws);
  "
}

# Get list of pages/tabs
list_pages() {
  curl -s -H "Host: localhost" "${CDP_URL}/json/list" | node -e "
    const pages = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
    pages.forEach((p, i) => {
      const ws = p.webSocketDebuggerUrl.replace('ws://localhost/', 'ws://${HOST_IP}:${CDP_PORT}/');
      console.log(\`[\${i}] \${p.title}\`);
      console.log(\`    URL: \${p.url}\`);
      console.log(\`    WS:  \${ws}\`);
    });
  "
}

case "$COMMAND" in
  check)
    if check_connection; then
      echo "✓ ${APP} CDP endpoint reachable at ${CDP_URL}"
      curl -s -H "Host: localhost" "${CDP_URL}/json/version" | node -e "
        const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
        const ws = data.webSocketDebuggerUrl.replace('ws://localhost/', 'ws://${HOST_IP}:${CDP_PORT}/');
        console.log('Browser:', data.Browser);
        console.log('Protocol:', data['Protocol-Version']);
        console.log('WebSocket:', ws);
      "
    fi
    ;;

  connect)
    # Output Playwright connection config as JSON
    if ! check_connection; then exit 1; fi
    WS=$(get_ws_endpoint)
    echo "{ \"wsEndpoint\": \"${WS}\" }"
    ;;

  pages|tabs)
    if ! check_connection; then exit 1; fi
    echo "Pages in ${APP}:"
    echo ""
    list_pages
    ;;

  ws|websocket)
    # Just output the WebSocket URL
    if ! check_connection; then exit 1; fi
    get_ws_endpoint
    ;;

  *)
    cat <<EOF
Usage: cdp-browser <app> <command>

Apps: ${!CDP_PORTS[@]}

Commands:
  check              - Test if app CDP endpoint is reachable
  connect            - Get Playwright connection config (JSON)
  pages|tabs         - List all pages/tabs in the app
  ws|websocket       - Get WebSocket debugger URL

Environment variables:
  HOST_IP            - Host machine IP (default: host.docker.internal)

Examples:
  # Check if Superhuman is running with CDP
  cdp-browser superhuman check

  # Get Morgen's WebSocket endpoint
  cdp-browser morgen ws

  # List Chrome tabs
  cdp-browser chrome pages

  # Connect with Playwright
  WS=\$(cdp-browser superhuman ws)
  node -e "
    const playwright = require('playwright');
    (async () => {
      const browser = await playwright.chromium.connectOverCDP('\${WS}');
      const page = browser.contexts()[0].pages()[0];
      console.log(await page.title());
    })();
  "
EOF
    exit 1
    ;;
esac
